name: Build Chess Project (Fixed)
on: [push, pull_request]

jobs:
  build-windows:
    runs-on: windows-2025
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup MSBuild from VS 2026
        run: |
          # 配置 MSBuild 为 VS 2026 版本（避免调用 VS 2022）
          $msbuildPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
          echo "MSBuildPath=$msbuildPath" >> $env:GITHUB_ENV
          # 将 VS 2026 工具集路径加入环境变量
          echo "${{ steps.vs2026.outputs.VS2026_PATH }}\MSBuild\Current\Bin" >> $env:GITHUB_PATH

      - name: Build with Forced PlatformToolset (v143)
        run: |
          # 核心：强制指定 VS 2026 内置的 v143 工具集 + 镜像预装的 Windows SDK 10.0.26100.0
          & $env:MSBuildPath `
            Chess/Chess.vcxproj `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=10.0.26100.0 `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:VCToolsVersion=14.50.35719 ` # 镜像预装的 VC++ 2022 版本
            /m /fl /flp:LogFile=build.log;Verbosity=detailed

      - name: Upload Build Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log