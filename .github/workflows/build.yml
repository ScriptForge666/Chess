name: Build Chess Project
on: [push, pull_request]

jobs:
  build-windows:
    runs-on: windows-2025  # 对应镜像版本 20260203.4.1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild Path
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64
          # 复用镜像内置的 VS 2026，无需指定版本

      - name: Verify VS/VC Environment
        run: |
          # 验证镜像内置的 VC 工具集和 Windows SDK
          vswhere -products * -latest -property installationPath
          Get-ChildItem "C:\Program Files\Microsoft Visual Studio\18\Enterprise\MSBuild\Microsoft\VC\v170\Platforms\x64\PlatformToolsets\"
          echo "Windows SDK Version: $env:WINDOWSSDKDIR"

      - name: Build Chess.vcxproj (覆盖工具集版本)
        run: |
          # 核心：指定 v143（镜像内置）替代 v145，同时指定镜像预装的 Windows SDK 10.0.26100.0
          msbuild Chess/Chess.vcxproj `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=10.0.26100.0 `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /m /fl /flp:LogFile=build.log;Verbosity=detailed

      - name: (可选) 自动重定向项目到当前 VS 版本
        if: failure()  # 若上面编译失败，尝试自动重定向
        run: |
          # 重定向解决方案到 VS 2026 兼容版本
          msbuild Chess/Chess.vcxproj /t:RetargetSolution /p:TargetPlatformVersion=10.0.26100.0
          # 重新编译
          msbuild Chess/Chess.vcxproj /p:Configuration=Release /p:Platform=x64 /m

      - name: Upload Build Log (失败时)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log